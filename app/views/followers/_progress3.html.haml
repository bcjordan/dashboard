- stage_map = @all_script_levels.group_by { |sl| sl.level.game }

- stages = []

- widthpx = 7

#progress
  - @section_map.each_pair do |section, students|
    .progressheader
      .studentname{style: "width: 160px; float: left"}
        &nbsp;
      - stage_map.each_pair do |game, levels|
        - width = levels.length
        - if width > 1
          - background_color = cycle("#666", "#777")
          .stage{style: "background-color: #{background_color}; color: white; float:left; width: #{width * widthpx}px; padding: 5px"}
            =game.name
    - student_ids = []           
    - students.each do |student|
      - student_ids << student.id
      .clear
      .studentrow
        .studentname{style: "width: 160px; float: left; height: 40px"}
          .gap{style: "height:10px"}
            &nbsp;
          = link_to student.name, user_stats_path(student)
        .studentzone{style: "float: left; position: relative"}
          - reset_cycle
          - stage_map.each_pair do |game, levels|
            - width = levels.length
            - if width > 1
              - background_color = cycle("#dadada", "#eeeeee")
              .stage{style: "background-color: #{background_color}; color: white; float:left; width: #{width * widthpx}px; padding: 5px; height:30px;"}
                &nbsp;    
          .studentbar{style: "position: absolute", id: "studentbar_#{student.id}"}
          .studentdot{style: "position: absolute; left: 0px; padding-top:4px; padding-bottom:4px", id: "studentdot_#{student.id}"}
            .dot{style: "border-radius: 20px; background-color: rgb(14, 190, 14); padding: 7px; color: white; width: 18px; height: 18px; font-weight: 600; cursor:default"}
              35
   
        .clear

    :javascript
      var studentIds = JSON.parse('#{student_ids.to_json}'); 

%br/


:javascript
  $.ready()
  {

    for (var s = 0; s < studentIds.length; s++)
    {
      // animate each student's dot the right level
      var level = Math.floor(Math.random() * 100);
      var id = "#studentdot_" + studentIds[s];
      $(id).animate({left: level * 7 -15 + "px"}, 4000, "easeInOutCubic");
      $(id + " .dot").text(level);

      // set dot color
      if (level < 30)
      {
        $(id + " .dot").css("background-color", "rgb(230, 90, 90)");
      }
      // draw the level history
      var id = "#studentbar_" + studentIds[s];
      for (var l = 0; l < level; l++)
      {
        var backgroundColor = Math.random() > 0.5 ? "rgb(14, 190, 14)" : "rgb(230, 90, 90)";
        $(id).append('<div class="bar" style="display:none; float:left; width:7px; margin-top:15px; height: 10px; cursor: default; background-color: '+ backgroundColor + '" >&nbsp;</div>');
      }
      setTimeout(function() { $(".studentbar .bar").fadeIn(3000); }, 3000);

    }



  }