#!/usr/bin/env ruby

require 'yaml'
require 'rake'
require_relative '../../deployment.rb'

$stage = nil
$level = 0
$concepts = []
$skin = nil
$hash = {}
$script_name

def stage(name)
  $stage = name
  $level = 0
  $concepts = []
  $skin = nil
  $hash["en"]["data"]["script"]["name"][$script_name][$stage] = $stage
end

def concepts(*items)
  $concepts = items
end

def skin(name)
  $skin = name
end

def level(name)
  puts [$stage, $concepts.join(','), name].join("\t")
end

# Create locale file for scripts
$hash = {"en" => {"data" => {"script" => {"name" => {}}}}}

source = File.expand_path(ARGV.fetch(0, Deploy.dir('dashboard/config/scripts/*.script')))

Dir.glob(source).each do |script|
  $script_name = script.gsub(/.*\/(\w+).script$/, '\1')
  $hash["en"]["data"]["script"]["name"][$script_name] = {"desc" => "Custom script #{$script_name}"}

  $stdout.reopen("#{script}.csv", "w")
  puts %w(Stage Concepts Name).join("\t")
  load script
end

File::open(Deploy.dir('dashboard/config/locales/scripts.en.yml'), "w+") do |f|
  f << "# Autogenerated by #{$0}. Do not edit by hand."
  f << $hash.to_yaml
end

system('rake seed:scripts')
